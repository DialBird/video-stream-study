# Video Stream Study

YouTubeのような動画ストリーミングWebサービスです。管理画面から動画をアップロードし、公開サイトで誰でもストリーミング再生できるプラットフォームを提供します。

## 主な機能

### 動画アップロード機能
- 管理画面から動画ファイル（MP4など）をアップロード
- タイトルと説明文の設定
- リアルタイムのアップロード進捗表示
- S3ストレージへの自動保存

### 動画ストリーミング再生
- HTML5 Videoを使用した高品質なストリーミング再生
- レスポンシブデザイン対応
- 視聴回数の自動カウント
- 動画の詳細情報表示

### 管理機能
- アップロード済み動画の一覧表示
- 動画の削除機能
- ユーザー認証（Manus OAuth）

## 技術スタック

- **フロントエンド**: React 19 + TypeScript + Tailwind CSS 4
- **バックエンド**: Express 4 + tRPC 11
- **データベース**: MySQL (Drizzle ORM)
- **ストレージ**: S3互換ストレージ
- **認証**: Manus OAuth

## プロジェクト構造

```
video-stream-study/
├── client/                 # フロントエンドコード
│   ├── src/
│   │   ├── pages/         # ページコンポーネント
│   │   │   ├── Home.tsx           # 動画一覧ページ
│   │   │   ├── AdminVideos.tsx    # 管理画面
│   │   │   └── VideoWatch.tsx     # 動画視聴ページ
│   │   ├── components/    # 再利用可能なコンポーネント
│   │   └── lib/trpc.ts    # tRPCクライアント設定
├── server/                # バックエンドコード
│   ├── routers.ts         # tRPCルーター定義
│   ├── db.ts              # データベースヘルパー
│   └── uploadHandler.ts   # 動画アップロード処理
├── drizzle/               # データベーススキーマ
│   └── schema.ts          # テーブル定義
└── storage/               # S3ストレージヘルパー
```

## データベーススキーマ

### videos テーブル
- `id`: 動画ID（主キー）
- `title`: 動画タイトル
- `description`: 動画の説明
- `fileKey`: S3ファイルキー
- `url`: 公開URL
- `mimeType`: ファイル形式
- `fileSize`: ファイルサイズ
- `duration`: 再生時間（秒）
- `thumbnailUrl`: サムネイルURL
- `uploadedBy`: アップロードユーザーID
- `viewCount`: 視聴回数
- `isPublished`: 公開状態
- `createdAt`: 作成日時
- `updatedAt`: 更新日時

## API エンドポイント

### tRPC プロシージャ

#### `video.create`
動画メタデータを作成（認証必須）

#### `video.listAll`
全動画の一覧取得（認証必須）

#### `video.list`
公開動画の一覧取得（公開）

#### `video.getById`
動画詳細の取得（公開）

#### `video.incrementView`
視聴回数のインクリメント（公開）

#### `video.delete`
動画の削除（認証必須）

### REST エンドポイント

#### `POST /api/upload-video`
動画ファイルのアップロード
- Content-Type: multipart/form-data
- 最大ファイルサイズ: 500MB
- 対応形式: video/*

## 開発環境のセットアップ

### Manus Platformでの開発（推奨）

このプロジェクトはManus Platform上で開発されており、環境変数やインフラが自動的に設定されます。

### ローカル環境でのセットアップ

#### Dockerを使用する場合（推奨）

Docker Composeを使用すると、MySQL、MinIO、開発環境を一括で起動できます。詳細は **[DOCKER_SETUP.md](./DOCKER_SETUP.md)** を参照してください。

```bash
# クイックスタート
git clone https://github.com/DialBird/video-stream-study.git
cd video-stream-study
make up
```

#### Dockerを使用しない場合

手動で環境を構築する場合は、**[LOCAL_SETUP.md](./LOCAL_SETUP.md)** を参照してください。以下の設定が必要です：

- Node.js v18以上
- pnpm v8以上
- MySQL v8以上
- S3ストレージ（AWS S3またはMinIO）
- 環境変数の設定（`.env`ファイル）

## 使用方法

### 動画のアップロード
1. ログインボタンからManus OAuthで認証
2. 「管理画面」ボタンをクリック
3. タイトルと説明を入力
4. 動画ファイルを選択
5. 「アップロード」ボタンをクリック

### 動画の視聴
1. ホームページで動画カードをクリック
2. 動画プレイヤーで再生
3. 視聴回数が自動的にカウントされます

## ストリーミング技術

このプロジェクトでは、HTML5の`<video>`タグを使用してストリーミング再生を実現しています。ブラウザが自動的に**プログレッシブダウンロード**と**レンジリクエスト**を処理するため、以下の利点があります：

- **即座の再生開始**: 動画全体のダウンロードを待たずに再生開始
- **シーク機能**: 動画の任意の位置にジャンプ可能
- **帯域幅の最適化**: 必要な部分のみをダウンロード
- **クロスブラウザ対応**: 主要ブラウザで標準サポート

S3ストレージがHTTP Range Requestsをサポートしているため、追加の設定なしでストリーミング配信が可能です。

## セキュリティ

- ユーザー認証はManus OAuthで管理
- 動画アップロードは認証済みユーザーのみ
- ファイルキーにランダムサフィックスを付与して列挙攻撃を防止
- S3バケットは公開設定（URLを知っている人のみアクセス可能）

## パフォーマンス最適化

- tRPCによる型安全なAPI通信
- React Queryによる自動キャッシング
- レスポンシブ画像とビデオの最適化
- 遅延ロードとコード分割

## 今後の拡張案

- [ ] サムネイル自動生成
- [ ] 動画の再生時間自動取得
- [ ] コメント機能
- [ ] いいね/評価機能
- [ ] プレイリスト機能
- [ ] 動画の公開/非公開切り替え
- [ ] HLS/DASHによる適応的ストリーミング
- [ ] 動画のトランスコーディング

## ライセンス

このプロジェクトはMIT Licenseの下で公開されています。
